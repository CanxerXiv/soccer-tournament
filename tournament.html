<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Tournament Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .bracket { display: flex; justify-content: center; padding: 20px; overflow-x: auto; }
        .round { display: flex; flex-direction: column; justify-content: center; width: 250px; margin: 0 50px; }
        .match { position: relative; background-color: #374151; border-radius: 0.5rem; margin: 30px 0; padding: 10px; }
        .match:after { content: ''; position: absolute; right: -25px; top: 50%; transform: translateY(-50%); width: 25px; height: 2px; background-color: #4b5563; }
        .round:last-child .match:after { display: none; }
        .match-connector { position: absolute; right: -50px; top: 50%; transform: translateY(-50%); width: 50px; height: 2px; background-color: #4b5563; }
        .match-connector:before, .match-connector:after { content: ''; position: absolute; width: 25px; height: 50px; border: solid 2px #4b5563; border-left: none; }
        .match-connector:before { top: -50px; right: 0; border-bottom: none; border-top-right-radius: 10px; }
        .match-connector:after { bottom: -50px; right: 0; border-top: none; border-bottom-right-radius: 10px; }
        .round-final .match-connector { display: none; }
        .tab-button.active { background-color: #374151; color: #fff; }
        .admin-only { display: none; }
        .admin-mode .admin-only { display: inline-block; }
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #1f2937; margin: 15% auto; padding: 20px; border-radius: 1rem; width: 90%; max-width: 500px;
        }
        /* Responsive adjustments for bracket */
        @media (max-width: 768px) {
            .round { width: 150px; margin: 0 20px; }
            .match:after { right: -15px; width: 15px; }
            .match-connector { right: -30px; width: 30px; }
            .match-connector:before, .match-connector:after { width: 15px; height: 30px; }
            .match-connector:before { top: -30px; }
            .match-connector:after { bottom: -30px; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1f2937',
                        'secondary-dark': '#374151',
                        'accent-green': '#10b981',
                        'text-light': '#d1d5db',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">âš½ Soccer Tournament Manager</h1>
            <p class="text-text-light">Manage teams, groups, fixtures, and track real-time statistics.</p>
        </header>

        <!-- Admin Toggle -->
        <div class="flex justify-end mb-4">
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" value="" id="admin-toggle" class="sr-only peer" onchange="toggleAdminMode()">
                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-green"></div>
                <span class="ml-3 text-sm font-medium text-text-light">Admin Mode</span>
            </label>
        </div>

        <!-- Tab Navigation -->
        <nav class="flex justify-center bg-secondary-dark p-2 rounded-xl mb-6">
            <button class="tab-button px-4 py-2 mx-2 rounded-lg transition-colors duration-150 text-text-light hover:bg-gray-600 active" onclick="showTab('teams')">Teams</button>
            <button class="tab-button px-4 py-2 mx-2 rounded-lg transition-colors duration-150 text-text-light hover:bg-gray-600" onclick="showTab('groups')">Groups</button>
            <button class="tab-button px-4 py-2 mx-2 rounded-lg transition-colors duration-150 text-text-light hover:bg-gray-600" onclick="showTab('fixtures')">Fixtures</button>
            <button class="tab-button px-4 py-2 mx-2 rounded-lg transition-colors duration-150 text-text-light hover:bg-gray-600" onclick="showTab('stats')">Stats</button>
            <button class="tab-button px-4 py-2 mx-2 rounded-lg transition-colors duration-150 text-text-light hover:bg-gray-600" onclick="showTab('bracket')">Bracket</button>
        </nav>

        <!-- Teams Tab -->
        <div id="teams-tab" class="tab-content">
            <h2 class="text-2xl font-semibold text-white mb-4">Registered Teams</h2>
            <button class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150 mb-4" onclick="exportToExcel('teams')">Export Teams to Excel</button>

            <ul id="teams-list" class="space-y-3 mb-6"></ul>

            <form id="add-team-form" class="admin-only bg-secondary-dark p-6 rounded-xl shadow-lg space-y-4">
                <h3 class="text-xl font-medium text-white">Add New Team</h3>
                <div>
                    <input type="text" id="team-name" placeholder="Team Name" required class="w-full p-3 rounded-lg bg-gray-600 text-white border border-gray-500 focus:border-accent-green focus:ring focus:ring-accent-green/50">
                </div>
                <div>
                    <input type="text" id="team-coach" placeholder="Coach Name" required class="w-full p-3 rounded-lg bg-gray-600 text-white border border-gray-500 focus:border-accent-green focus:ring focus:ring-accent-green/50">
                </div>
                <button type="submit" class="w-full bg-accent-green text-white font-bold p-3 rounded-lg hover:bg-emerald-700 transition duration-150">Add Team</button>
            </form>
        </div>

        <!-- Groups Tab -->
        <div id="groups-tab" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-semibold text-white mb-4">Group Standings</h2>
            <button class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150 mb-4" onclick="exportToExcel('groups')">Export Group Standings to Excel</button>
            <div id="groups-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Group cards will be rendered here -->
            </div>
            <div class="admin-only mt-6 flex justify-center space-x-4">
                <button onclick="generateGroups()" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150">Generate Groups (Auto-Draw)</button>
            </div>
        </div>

        <!-- Fixtures Tab -->
        <div id="fixtures-tab" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-semibold text-white mb-4">Fixtures & Results</h2>
            <button class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150 mb-4" onclick="exportToExcel('fixtures')">Export Fixtures to Excel</button>
            <div id="fixtures-container" class="space-y-4">
                <!-- Fixtures will be rendered here -->
            </div>
            <div class="admin-only mt-6 flex justify-center space-x-4">
                <button onclick="generateFixtures()" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150">Generate Group Stage Fixtures</button>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-semibold text-white mb-4">Player Statistics (Top Scorers & Assists)</h2>
            <button class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150 mb-4" onclick="exportToExcel('stats')">Export Player Stats to Excel</button>
            <div id="stats-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Stats will be rendered here -->
            </div>
        </div>

        <!-- Bracket Tab -->
        <div id="bracket-tab" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-semibold text-white mb-4 text-center">Tournament Bracket</h2>
            <div id="bracket-container" class="bracket">
                <!-- Bracket will be rendered here -->
            </div>
            <div class="admin-only mt-6 flex justify-center space-x-4">
                <button onclick="generateBracket()" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150">Generate Knockout Bracket</button>
            </div>
        </div>
    </div>

    <!-- Modal for Player Management -->
    <div id="player-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-white">Manage Players for [Team]</h3>
                <span class="text-3xl font-bold cursor-pointer text-text-light hover:text-white" onclick="closeModal()">&times;</span>
            </div>

            <div class="admin-only">
                <form id="add-player-form" class="space-y-3 mb-6">
                    <input type="hidden" id="modal-team-id">
                    <input type="text" id="player-name" placeholder="Player Name" required class="w-full p-3 rounded-lg bg-gray-600 text-white border border-gray-500">
                    <button type="submit" class="w-full bg-accent-green text-white p-3 rounded-lg hover:bg-emerald-700 transition duration-150">Add Player</button>
                </form>
            </div>

            <h4 class="text-lg font-semibold text-text-light mb-3">Player List</h4>
            <ul id="modal-player-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <!-- Players will be rendered here -->
            </ul>
        </div>
    </div>

    <script>
        let db = {
            teams: [],
            groups: [],
            fixtures: [],
            nextTeamId: 1,
            nextPlayerId: 1,
            nextFixtureId: 1,
        };

        let currentTab = 'teams';
        const modal = document.getElementById('player-modal');
        const adminToggle = document.getElementById('admin-toggle');

        // --- UTILITY FUNCTIONS ---

        function saveDb() {
            localStorage.setItem('tournamentDb', JSON.stringify(db));
        }

        function loadDb() {
            const data = localStorage.getItem('tournamentDb');
            if (data) {
                db = JSON.parse(data);
                // Ensure all necessary properties exist after loading
                db.teams.forEach(t => {
                    t.players = t.players || [];
                    t.pts = t.pts || 0;
                    t.p = t.p || 0;
                    t.w = t.w || 0;
                    t.d = t.d || 0;
                    t.l = t.l || 0;
                    t.gf = t.gf || 0;
                    t.ga = t.ga || 0;
                    t.gd = t.gd || 0;
                    t.players.forEach(p => {
                        p.goals = p.goals || 0;
                        p.assists = p.assists || 0;
                    });
                });
                db.fixtures.forEach(f => {
                    f.isGroupStage = f.isGroupStage !== undefined ? f.isGroupStage : true;
                });
            }
        }

        function toggleAdminMode() {
            document.body.classList.toggle('admin-mode', adminToggle.checked);
            renderAll();
        }

        function showAlert(message) {
            console.log("Alert: " + message); // Using console log instead of alert
            // In a real app, you'd show a custom modal/toast here.
        }

        // --- EXPORT FUNCTIONALITY (NEW) ---

        function exportToExcel(dataType) {
            let csv = '\ufeff'; // BOM to ensure Excel handles UTF-8 correctly
            let filename = '';

            // Helper function to escape strings for CSV
            const escapeCsv = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str).replace(/"/g, '""');
                if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes(';')) {
                    return `"${str}"`;
                }
                return str;
            };
            
            // Map team IDs to names for readability in exports
            const teamsMap = new Map(db.teams.map(t => [t.id, t.name]));

            switch (dataType) {
                case 'teams':
                    filename = 'tournament_teams.xls';
                    csv += 'Team Name,Coach Name,Players\n';
                    db.teams.forEach(team => {
                        const playerNames = team.players.map(p => p.name).join('; ');
                        csv += `${escapeCsv(team.name)},${escapeCsv(team.coach)},${escapeCsv(playerNames)}\n`;
                    });
                    break;

                case 'groups':
                    filename = 'tournament_groups.xls';
                    // Ensure standings are calculated before export
                    db.groups.forEach(group => calculateGroupStandings(group.name));

                    db.groups.forEach(group => {
                        csv += `\nGroup: ${escapeCsv(group.name)}\n`;
                        csv += 'Team,Played,Win,Draw,Loss,Goals For,Goals Against,Goal Difference,Points\n';
                        // Sort standings before exporting (same logic as used in rendering)
                        const sortedStandings = [...group.standings].sort((a, b) => {
                            if (b.pts !== a.pts) return b.pts - a.pts;
                            if (b.gd !== a.gd) return b.gd - a.gd;
                            if (b.gf !== a.gf) return b.gf - a.gf;
                            return a.teamName.localeCompare(b.teamName);
                        });
                        
                        sortedStandings.forEach(standing => {
                            csv += `${escapeCsv(standing.teamName)},${standing.p},${standing.w},${standing.d},${standing.l},${standing.gf},${standing.ga},${standing.gd},${standing.pts}\n`;
                        });
                    });
                    break;

                case 'fixtures':
                    filename = 'tournament_fixtures.xls';
                    csv += 'Round,Team 1,Team 2,Score,Winner\n';
                    db.fixtures.forEach(fixture => {
                        const team1Name = teamsMap.get(fixture.team1Id);
                        const team2Name = teamsMap.get(fixture.team2Id);
                        const score = fixture.score ? `${fixture.score.t1}-${fixture.score.t2}` : 'vs';
                        const winnerName = fixture.winnerId ? teamsMap.get(fixture.winnerId) : 'N/A';

                        csv += `${escapeCsv(fixture.round)},${escapeCsv(team1Name)},${escapeCsv(team2Name)},${escapeCsv(score)},${escapeCsv(winnerName)}\n`;
                    });
                    break;

                case 'stats':
                    filename = 'tournament_stats.xls';
                    csv += 'Player Name,Team,Goals,Assists\n';
                    // Flatten all players with stats
                    let allPlayers = [];
                    db.teams.forEach(team => {
                        team.players.forEach(player => {
                            if (player.goals > 0 || player.assists > 0) {
                                allPlayers.push({
                                    name: player.name,
                                    team: team.name,
                                    goals: player.goals,
                                    assists: player.assists
                                });
                            }
                        });
                    });
                    // Sort by goals (desc) then assists (desc)
                    allPlayers.sort((a, b) => {
                        if (b.goals !== a.goals) return b.goals - a.goals;
                        return b.assists - a.assists;
                    });

                    allPlayers.forEach(player => {
                        csv += `${escapeCsv(player.name)},${escapeCsv(player.team)},${player.goals},${player.assists}\n`;
                    });
                    break;

                default:
                    console.error('Unknown data type for export:', dataType);
                    return;
            }

            // Create a Blob and trigger download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showAlert('Your browser does not support downloading files directly.');
            }
        }
        window.exportToExcel = exportToExcel;


        // --- TEAM MANAGEMENT ---

        function addTeam(event) {
            event.preventDefault();
            const nameInput = document.getElementById('team-name');
            const coachInput = document.getElementById('team-coach');
            const newTeam = {
                id: db.nextTeamId++,
                name: nameInput.value.trim(),
                coach: coachInput.value.trim(),
                players: [],
                p: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0,
            };
            if (newTeam.name) {
                db.teams.push(newTeam);
                saveDb();
                renderTeams();
                nameInput.value = '';
                coachInput.value = '';
            }
        }

        function deleteTeam(teamId) {
            db.teams = db.teams.filter(t => t.id !== teamId);
            // Also remove related fixtures and group references
            db.fixtures = db.fixtures.filter(f => f.team1Id !== teamId && f.team2Id !== teamId);
            db.groups.forEach(group => {
                group.teams = group.teams.filter(id => id !== teamId);
            });
            db.groups = db.groups.filter(g => g.teams.length > 0); // Remove empty groups
            db.fixtures = db.fixtures.filter(f => f.winnerId !== teamId); // Remove winner references
            saveDb();
            renderAll();
        }

        function openModal(teamId) {
            const team = db.teams.find(t => t.id === teamId);
            if (!team) return;

            document.getElementById('modal-title').textContent = `Manage Players for ${team.name}`;
            document.getElementById('modal-team-id').value = teamId;

            renderModalPlayerList(teamId);
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function addPlayer(event) {
            event.preventDefault();
            const teamId = parseInt(document.getElementById('modal-team-id').value);
            const playerNameInput = document.getElementById('player-name');
            const team = db.teams.find(t => t.id === teamId);

            if (team && playerNameInput.value.trim()) {
                const newPlayer = {
                    id: db.nextPlayerId++,
                    name: playerNameInput.value.trim(),
                    goals: 0,
                    assists: 0
                };
                team.players.push(newPlayer);
                saveDb();
                renderModalPlayerList(teamId);
                playerNameInput.value = '';
                renderStats(); // Update stats in case it affects current ranking
            }
        }

        function deletePlayer(teamId, playerId) {
            const team = db.teams.find(t => t.id === teamId);
            if (team) {
                team.players = team.players.filter(p => p.id !== playerId);
                saveDb();
                renderModalPlayerList(teamId);
                renderStats();
            }
        }

        function renderModalPlayerList(teamId) {
            const team = db.teams.find(t => t.id === teamId);
            const list = document.getElementById('modal-player-list');
            
            if (!team || !team.players || team.players.length === 0) { 
                list.innerHTML = `<li class="p-2 text-center text-gray-400">No players added.</li>`; 
                return; 
            }
            
            list.innerHTML = team.players.map(p => `
                <li class="flex justify-between items-center bg-gray-600 p-2 rounded-md">
                    <span>${p.name}</span>
                    <button class="admin-only text-xs bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700" 
                            onclick="deletePlayer(${teamId}, ${p.id})">Remove</button>
                </li>
            `).join('');
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // --- GROUP & FIXTURES MANAGEMENT ---

        function generateGroups(numGroups = 4) {
            if (db.teams.length < numGroups) {
                showAlert(`Need at least ${numGroups} teams to generate ${numGroups} groups.`);
                return;
            }
            db.groups = [];
            const shuffledTeams = [...db.teams].sort(() => 0.5 - Math.random());
            for (let i = 0; i < numGroups; i++) {
                db.groups.push({ name: `Group ${String.fromCharCode(65 + i)}`, teams: [] });
            }

            shuffledTeams.forEach((team, index) => {
                db.groups[index % numGroups].teams.push(team.id);
            });

            saveDb();
            renderGroups();
            showAlert(`Successfully generated ${numGroups} groups.`);
        }

        function generateFixtures() {
            db.fixtures = [];
            db.nextFixtureId = 1;

            if (db.groups.length === 0) {
                showAlert('Please generate groups first.');
                return;
            }

            db.groups.forEach(group => {
                const teamIds = group.teams;
                if (teamIds.length < 2) return;

                // Simple Round-Robin for group stage
                for (let i = 0; i < teamIds.length; i++) {
                    for (let j = i + 1; j < teamIds.length; j++) {
                        db.fixtures.push({
                            id: db.nextFixtureId++,
                            round: group.name,
                            team1Id: teamIds[i],
                            team2Id: teamIds[j],
                            score: null,
                            winnerId: null,
                            isGroupStage: true
                        });
                    }
                }
            });

            saveDb();
            renderFixtures();
            showAlert(`Generated ${db.fixtures.length} group stage fixtures.`);
        }

        function updateFixtureScore(fixtureId, score1, score2) {
            const fixture = db.fixtures.find(f => f.id === fixtureId);
            if (!fixture) return;

            const t1Score = parseInt(score1);
            const t2Score = parseInt(score2);

            if (isNaN(t1Score) || isNaN(t2Score) || t1Score < 0 || t2Score < 0) {
                showAlert('Invalid score entered.');
                return;
            }

            fixture.score = { t1: t1Score, t2: t2Score };

            if (t1Score > t2Score) {
                fixture.winnerId = fixture.team1Id;
            } else if (t2Score > t1Score) {
                fixture.winnerId = fixture.team2Id;
            } else {
                fixture.winnerId = 'draw'; // Use a special identifier for draw
            }

            // Recalculate stats/standings if it was a group stage match
            if (fixture.isGroupStage) {
                resetTeamStats();
                recalculateAllStats();
            }

            // Re-render and save
            saveDb();
            renderFixtures();
            renderGroups();
            renderStats();
            // If it was a knockout match, update bracket
            if (!fixture.isGroupStage) {
                renderBracket();
            }
        }

        function resetTeamStats() {
            db.teams.forEach(t => { t.p = 0; t.w = 0; t.d = 0; t.l = 0; t.gf = 0; t.ga = 0; t.gd = 0; t.pts = 0; });
        }

        function recalculateAllStats() {
            db.fixtures.filter(f => f.isGroupStage && f.score).forEach(fixture => {
                const t1 = db.teams.find(t => t.id === fixture.team1Id);
                const t2 = db.teams.find(t => t.id === fixture.team2Id);
                const s1 = fixture.score.t1;
                const s2 = fixture.score.t2;

                if (t1 && t2) {
                    // Update P, GF, GA, GD
                    t1.p++; t2.p++;
                    t1.gf += s1; t1.ga += s2; t1.gd = t1.gf - t1.ga;
                    t2.gf += s2; t2.ga += s1; t2.gd = t2.gf - t2.ga;

                    // Update W, D, L, Pts
                    if (s1 > s2) {
                        t1.w++; t2.l++; t1.pts += 3;
                    } else if (s2 > s1) {
                        t2.w++; t1.l++; t2.pts += 3;
                    } else {
                        t1.d++; t2.d++; t1.pts += 1; t2.pts += 1;
                    }
                }
            });
            db.groups.forEach(group => calculateGroupStandings(group.name));
        }

        function calculateGroupStandings(groupName) {
            const group = db.groups.find(g => g.name === groupName);
            if (!group) return;

            group.standings = group.teams.map(teamId => {
                const team = db.teams.find(t => t.id === teamId);
                return {
                    teamId: team.id,
                    teamName: team.name,
                    p: team.p, w: team.w, d: team.d, l: team.l,
                    gf: team.gf, ga: team.ga, gd: team.gd, pts: team.pts
                };
            }).sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                if (b.gd !== a.gd) return b.gd - a.gd;
                if (b.gf !== a.gf) return b.gf - a.gf;
                return a.teamName.localeCompare(b.teamName);
            });
        }

        // --- BRACKET MANAGEMENT ---

        function getGroupWinnersAndRunnersUp() {
            let qualifiedTeams = [];
            db.groups.forEach(group => {
                calculateGroupStandings(group.name); // Ensure standings are fresh
                if (group.standings.length >= 2) {
                    qualifiedTeams.push({ teamId: group.standings[0].teamId, seed: `${group.name} Winner` });
                    qualifiedTeams.push({ teamId: group.standings[1].teamId, seed: `${group.name} Runner-up` });
                }
            });
            // Simple logic: 8 teams total for QF: 4 Winners, 4 Runners-up.
            if (qualifiedTeams.length < 8) {
                 // Fallback for smaller groups: fill with top teams until 8
                const allTeams = [...db.teams].sort((a, b) => b.pts - a.pts);
                while (qualifiedTeams.length < 8 && allTeams.length > qualifiedTeams.length) {
                    const teamId = allTeams.pop().id;
                    if (!qualifiedTeams.some(t => t.teamId === teamId)) {
                        qualifiedTeams.push({ teamId: teamId, seed: 'Wildcard' });
                    }
                }
            }
            
            // Limit to 8 teams for Quarter-Finals
            return qualifiedTeams.slice(0, 8).map(t => t.teamId); 
        }

        function generateBracket() {
            const qualified = getGroupWinnersAndRunnersUp();
            if (qualified.length !== 8) {
                showAlert('Cannot generate bracket: Requires 8 qualified teams (4 group winners and 4 runners-up). Check groups and fixtures.');
                return;
            }

            db.fixtures = db.fixtures.filter(f => f.isGroupStage); // Clear existing knockout fixtures

            // Quarter-Finals (Round of 8)
            const qfMatches = [
                { team1Id: qualified[0], team2Id: qualified[3] }, // A1 vs D2
                { team1Id: qualified[1], team2Id: qualified[2] }, // B1 vs C2
                { team1Id: qualified[4], team2Id: qualified[7] }, // C1 vs B2
                { team1Id: qualified[5], team2Id: qualified[6] }, // D1 vs A2
            ];

            const qfFixtures = qfMatches.map((match, index) => ({
                id: db.nextFixtureId++,
                round: `Quarter-Final ${index + 1}`,
                ...match,
                score: null,
                winnerId: null,
                isGroupStage: false
            }));
            db.fixtures.push(...qfFixtures);
            
            // Semi-Finals (placeholders)
            db.fixtures.push(
                { id: db.nextFixtureId++, round: "Semi-Final 1", team1Id: null, team2Id: null, score: null, winnerId: null, isGroupStage: false, dependsOn: [qfFixtures[0].id, qfFixtures[1].id] },
                { id: db.nextFixtureId++, round: "Semi-Final 2", team1Id: null, team2Id: null, score: null, winnerId: null, isGroupStage: false, dependsOn: [qfFixtures[2].id, qfFixtures[3].id] }
            );

            // Final (placeholder)
            db.fixtures.push(
                { id: db.nextFixtureId++, round: "Final", team1Id: null, team2Id: null, score: null, winnerId: null, isGroupStage: false, dependsOn: [db.fixtures[db.fixtures.length - 2].id, db.fixtures[db.fixtures.length - 1].id] }
            );

            saveDb();
            renderBracket();
            showAlert('Knockout bracket generated!');
        }

        function updateBracketDependencies() {
            // This function ensures the Semi/Finals teams are set based on previous round winners
            const qfWinners = db.fixtures.filter(f => f.round.startsWith('Quarter-Final') && f.winnerId && f.winnerId !== 'draw').map(f => f.winnerId);
            const sf1 = db.fixtures.find(f => f.round === 'Semi-Final 1');
            const sf2 = db.fixtures.find(f => f.round === 'Semi-Final 2');
            const final = db.fixtures.find(f => f.round === 'Final');

            if (sf1) {
                sf1.team1Id = qfWinners[0] || null;
                sf1.team2Id = qfWinners[1] || null;
            }
            if (sf2) {
                sf2.team1Id = qfWinners[2] || null;
                sf2.team2Id = qfWinners[3] || null;
            }

            const sfWinners = db.fixtures.filter(f => f.round.startsWith('Semi-Final') && f.winnerId && f.winnerId !== 'draw').map(f => f.winnerId);
            if (final) {
                final.team1Id = sfWinners[0] || null;
                final.team2Id = sfWinners[1] || null;
            }
        }


        // --- RENDERING FUNCTIONS ---

        function renderTeams() {
            const list = document.getElementById('teams-list');
            list.innerHTML = db.teams.map(team => {
                return `
                    <li class="bg-secondary-dark p-4 rounded-xl shadow-md flex justify-between items-center transition duration-150 hover:bg-gray-700">
                        <div>
                            <span class="text-xl font-semibold text-white">${team.name}</span>
                            <p class="text-sm text-gray-400">Coach: ${team.coach} | Players: ${team.players.length}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition duration-150 text-sm" onclick="openModal(${team.id})">Manage Players</button>
                            <button class="admin-only bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition duration-150 text-sm" onclick="deleteTeam(${team.id})">Delete</button>
                        </div>
                    </li>
                `;
            }).join('') || '<p class="text-center text-gray-400">No teams added yet. Use Admin Mode to add one!</p>';
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = db.groups.map(group => {
                calculateGroupStandings(group.name); // Ensure standings are fresh
                const header = `<h4 class="text-lg font-bold text-accent-green p-3 bg-gray-700 rounded-t-lg">${group.name}</h4>`;
                const tableRows = group.standings.map(standing => {
                    const isQualified = group.standings.indexOf(standing) < 2;
                    return `
                        <tr class="${isQualified ? 'bg-gray-600 font-semibold' : 'bg-secondary-dark'} border-b border-gray-700 hover:bg-gray-500 transition duration-100">
                            <td class="px-4 py-2 flex items-center">
                                ${isQualified ? '<span class="text-green-400 mr-2">&#9679;</span>' : ''}
                                ${standing.teamName}
                            </td>
                            <td class="px-4 py-2">${standing.p}</td>
                            <td class="px-4 py-2 text-green-400">${standing.w}</td>
                            <td class="px-4 py-2">${standing.d}</td>
                            <td class="px-4 py-2 text-red-400">${standing.l}</td>
                            <td class="px-4 py-2">${standing.gf}</td>
                            <td class="px-4 py-2">${standing.ga}</td>
                            <td class="px-4 py-2 font-bold">${standing.gd}</td>
                            <td class="px-4 py-2 bg-gray-800 font-extrabold">${standing.pts}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="bg-primary-dark rounded-xl shadow-lg overflow-hidden">
                        ${header}
                        <div class="p-4">
                            <table class="min-w-full text-sm text-left text-text-light">
                                <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-4 py-2">Team</th>
                                        <th scope="col" class="px-4 py-2">P</th>
                                        <th scope="col" class="px-4 py-2">W</th>
                                        <th scope="col" class="px-4 py-2">D</th>
                                        <th scope="col" class="px-4 py-2">L</th>
                                        <th scope="col" class="px-4 py-2">GF</th>
                                        <th scope="col" class="px-4 py-2">GA</th>
                                        <th scope="col" class="px-4 py-2">GD</th>
                                        <th scope="col" class="px-4 py-2">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-center text-gray-400">No groups generated. Use Admin Mode to draw them.</p>';
        }

        function renderFixtures() {
            const container = document.getElementById('fixtures-container');
            const teamsMap = new Map(db.teams.map(t => [t.id, t.name]));

            // Group fixtures by round
            const fixturesByRound = db.fixtures.reduce((acc, fixture) => {
                if (!acc[fixture.round]) acc[fixture.round] = [];
                acc[fixture.round].push(fixture);
                return acc;
            }, {});

            container.innerHTML = Object.entries(fixturesByRound).map(([round, fixtures]) => {
                const fixtureList = fixtures.map(f => {
                    const team1Name = teamsMap.get(f.team1Id) || 'TBD';
                    const team2Name = teamsMap.get(f.team2Id) || 'TBD';
                    const scoreDisplay = f.score ? `${f.score.t1} - ${f.score.t2}` : 'vs';
                    const winner = f.winnerId === 'draw' ? 'Draw' : (f.winnerId ? teamsMap.get(f.winnerId) : 'In Progress');
                    
                    const adminControls = adminToggle.checked && f.isGroupStage ? `
                        <div class="admin-only flex space-x-2 mt-2">
                            <input type="number" id="score1-${f.id}" placeholder="T1" class="w-12 p-1 text-center bg-gray-800 rounded-md text-white" value="${f.score ? f.score.t1 : ''}">
                            <input type="number" id="score2-${f.id}" placeholder="T2" class="w-12 p-1 text-center bg-gray-800 rounded-md text-white" value="${f.score ? f.score.t2 : ''}">
                            <button onclick="updateFixtureScore(${f.id}, document.getElementById('score1-${f.id}').value, document.getElementById('score2-${f.id}').value)" 
                                    class="bg-green-600 text-white px-2 py-1 rounded-md text-xs hover:bg-green-700">Set Score</button>
                        </div>
                    ` : '';
                    
                    const scoreClass = f.score ? 'bg-accent-green/20 border-accent-green' : 'bg-gray-700/20 border-gray-700';

                    return `
                        <div class="bg-secondary-dark p-4 rounded-lg shadow-md flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0">
                            <span class="font-medium w-full md:w-1/3 text-center md:text-left">${team1Name}</span>
                            <div class="flex flex-col items-center w-full md:w-1/3">
                                <span class="text-xl font-bold p-2 rounded-lg border ${scoreClass}">${scoreDisplay}</span>
                                <span class="text-xs text-gray-400 mt-1">Winner: ${winner}</span>
                            </div>
                            <span class="font-medium w-full md:w-1/3 text-center md:text-right">${team2Name}</span>
                            ${adminControls}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-primary-dark p-4 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">${round}</h3>
                        <div class="space-y-3">${fixtureList}</div>
                    </div>
                `;
            }).join('') || '<p class="text-center text-gray-400">No fixtures generated. Use Admin Mode to create them.</p>';
        }

        function renderStats() {
            const container = document.getElementById('stats-list');
            
            // 1. Flatten all players with stats
            let allPlayers = [];
            db.teams.forEach(team => {
                team.players.forEach(player => {
                    allPlayers.push({
                        name: player.name,
                        team: team.name,
                        goals: player.goals,
                        assists: player.assists
                    });
                });
            });

            // 2. Filter and Sort for Top Scorers
            const topScorers = [...allPlayers]
                .filter(p => p.goals > 0)
                .sort((a, b) => b.goals - a.goals)
                .slice(0, 10);

            // 3. Filter and Sort for Top Assists
            const topAssists = [...allPlayers]
                .filter(p => p.assists > 0)
                .sort((a, b) => b.assists - a.assists)
                .slice(0, 10);
            
            const renderStatList = (title, list, valueKey, valueLabel) => {
                const listItems = list.map((p, index) => `
                    <li class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
                        <span class="font-bold text-lg text-white">${index + 1}.</span>
                        <span class="flex-grow ml-4">${p.name} <span class="text-xs text-gray-400">(${p.team})</span></span>
                        <span class="text-lg font-extrabold text-accent-green">${p[valueKey]} ${valueLabel}</span>
                    </li>
                `).join('');

                return `
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-2">${title}</h3>
                        <ul class="space-y-2">${listItems || '<li class="text-center text-gray-400">No data recorded.</li>'}</ul>
                        <div class="admin-only mt-4">
                            <button onclick="showStatUpdateModal()" class="w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">Update Player Stats</button>
                        </div>
                    </div>
                `;
            };

            container.innerHTML = `
                ${renderStatList('Top Scorers', topScorers, 'goals', 'Goals')}
                ${renderStatList('Top Assists', topAssists, 'assists', 'Assists')}
            `;
        }

        function showStatUpdateModal() {
            // Function to show a modal for updating player goals/assists
            // (Implementation deferred, but placeholder button is ready for Admin Mode)
            showAlert("The stat update interface is not fully implemented, but data can be updated by setting fixture scores.");
        }


        function renderBracket() {
            updateBracketDependencies(); // Update team IDs based on winners
            const container = document.getElementById('bracket-container');
            const teamsMap = new Map(db.teams.map(t => [t.id, t.name]));
            const bracketFixtures = db.fixtures.filter(f => !f.isGroupStage);
            
            if (bracketFixtures.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">No bracket generated. Use Admin Mode to generate the knockout stage.</p>';
                return;
            }

            const rounds = {
                'Quarter-Final': [],
                'Semi-Final': [],
                'Final': []
            };

            bracketFixtures.forEach(f => {
                if (f.round.startsWith('Quarter-Final')) rounds['Quarter-Final'].push(f);
                else if (f.round.startsWith('Semi-Final')) rounds['Semi-Final'].push(f);
                else if (f.round.startsWith('Final')) rounds['Final'].push(f);
            });

            const renderMatch = (f) => {
                const team1Name = teamsMap.get(f.team1Id) || 'TBD';
                const team2Name = teamsMap.get(f.team2Id) || 'TBD';
                const score = f.score ? `${f.score.t1}-${f.score.t2}` : (f.team1Id && f.team2Id ? 'vs' : 'TBD');
                const winnerClass = f.winnerId && f.winnerId !== 'draw' ? 'bg-accent-green/20 border-accent-green' : 'border-gray-600';
                
                let adminControls = '';
                if (adminToggle.checked && f.team1Id && f.team2Id) {
                    adminControls = `
                        <div class="admin-only flex justify-center space-x-1 mt-2">
                            <input type="number" id="kscore1-${f.id}" placeholder="T1" class="w-10 p-0.5 text-center bg-gray-800 rounded-md text-white text-xs" value="${f.score ? f.score.t1 : ''}">
                            <input type="number" id="kscore2-${f.id}" placeholder="T2" class="w-10 p-0.5 text-center bg-gray-800 rounded-md text-white text-xs" value="${f.score ? f.score.t2 : ''}">
                            <button onclick="updateFixtureScore(${f.id}, document.getElementById('kscore1-${f.id}').value, document.getElementById('kscore2-${f.id}').value)" 
                                    class="bg-green-600 text-white px-1 py-0.5 rounded-md text-xs hover:bg-green-700">Set</button>
                        </div>
                    `;
                }

                return `
                    <div class="match border-2 ${winnerClass}">
                        <p class="text-xs text-gray-400">${f.round}</p>
                        <div class="font-medium text-white">${team1Name}</div>
                        <div class="text-sm text-gray-300">Score: ${score}</div>
                        <div class="font-medium text-white">${team2Name}</div>
                        ${adminControls}
                    </div>
                `;
            };

            // Assemble HTML for each round
            const qfHtml = rounds['Quarter-Final'].map(f => renderMatch(f)).join('<div class="match-connector admin-only"></div>');
            const sfHtml = rounds['Semi-Final'].map(f => renderMatch(f)).join('<div class="match-connector admin-only"></div>');
            const finalHtml = rounds['Final'].map(f => renderMatch(f)).join('');

            container.innerHTML = `
                <div class="round">
                    <h3 class="text-xl font-semibold text-center text-white mb-6">Quarter-Finals</h3>
                    ${qfHtml}
                </div>
                <div class="round">
                    <h3 class="text-xl font-semibold text-center text-white mb-6">Semi-Finals</h3>
                    ${sfHtml}
                </div>
                <div class="round round-final">
                    <h3 class="text-xl font-semibold text-center text-white mb-6">Final</h3>
                    ${finalHtml}
                </div>
            `;
        }


        function showTab(tabName) {
            currentTab = tabName;
            ['teams', 'groups', 'bracket', 'fixtures', 'stats'].forEach(tabId => { 
                document.getElementById(`${tabId}-tab`).style.display = tabName === tabId ? 'block' : 'none'; 
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if(btn.getAttribute('onclick') === `showTab('${tabName}')`) { btn.classList.add('active'); }
            });

            // Ensure the correct content is rendered when the tab is shown
            switch (tabName) {
                case 'teams': renderTeams(); break;
                case 'groups': renderGroups(); break;
                case 'fixtures': renderFixtures(); break;
                case 'stats': renderStats(); break;
                case 'bracket': renderBracket(); break;
            }
        }

        function renderAll() {
            renderTeams();
            renderGroups();
            renderFixtures();
            renderStats();
            renderBracket();
            showTab(currentTab); // Re-show the active tab to update content
        }

        // --- INITIAL RENDER ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDb();
            document.getElementById('add-team-form').addEventListener('submit', addTeam);
            document.getElementById('add-player-form').addEventListener('submit', addPlayer);
            
            // Initial render of all content
            renderAll();
            
            // Set initial admin state
            toggleAdminMode(); 
        });
    </script>
</body>
</html>
